version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: chatwoot_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  redis:
    image: redis:7
    container_name: chatwoot_redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: always

  chatwoot:
    image: chatwoot/chatwoot:latest
    container_name: chatwoot
    depends_on:
      - postgres
      - redis
    environment:
      NODE_ENV: production
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      POSTGRES_HOST: postgres
      POSTGRES_USERNAME: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DATABASE: ${POSTGRES_DB}
      REDIS_URL: redis://redis:6379
      FRONTEND_URL: ${CHATWOOT_FRONTEND_URL}
      BACKEND_URL: ${CHATWOOT_BACKEND_URL}
      SMTP_ADDRESS: ${SMTP_ADDRESS}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_DOMAIN: ${SMTP_DOMAIN}
      WEBHOOK_PROXY_URL: ${N8N_WEBHOOK_URL}
    ports:
      - "3000:3000"
    restart: always

  baileys:
    build:
      context: ./baileys
      dockerfile: Dockerfile
    container_name: baileys
    environment:
      CHATWOOT_URL: ${CHATWOOT_BACKEND_URL}
      CHATWOOT_TOKEN: ${CHATWOOT_API_TOKEN}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      SESSION_PATH: /sessions
    ports:
      - "8000:8000"
    volumes:
      - baileys_sessions:/sessions
    restart: always

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    environment:
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_PASS}
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      N8N_WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      NODE_ENV: production
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    restart: always

volumes:
  postgres_data:
  redis_data:
  baileys_sessions:
  n8n_data:
