services:
  # -------------------------
  # Chatwoot
  # -------------------------
  - type: web
    name: chatwoot
    env: docker
    plan: standard
    image: chatwoot/chatwoot:latest
    dockerCommand: sh -c "bundle exec rails db:chatwoot_prepare && bundle exec rails s -p 3000 -b 0.0.0.0"
    envVars:
      - key: NODE_ENV
        value: production
      - key: SECRET_KEY_BASE
        sync: false

      # Conexão com Supabase (PostgreSQL externo)
      - key: POSTGRES_HOST
        value: ${POSTGRES_HOST}
      - key: POSTGRES_PORT
        value: ${POSTGRES_PORT}
      - key: POSTGRES_USERNAME
        value: ${POSTGRES_USER}
      - key: POSTGRES_PASSWORD
        value: ${POSTRES_PASSWORD}
      - key: POSTGRES_DATABASE
        value: ${POSTGRES_DB}

      # Redis (Render managed)
      - key: REDIS_URL
        fromDatabase:
          name: redis
          property: connectionString

      # URLs públicas
      - key: FRONTEND_URL
        value: ${CHATWOOT_FRONTEND_URL}
      - key: BACKEND_URL
        value: ${CHATWOOT_BACKEND_URL}

      # SMTP
      - key: SMTP_ADDRESS
        value: ${SMTP_ADDRESS}
      - key: SMTP_PORT
        value: ${SMTP_PORT}
      - key: SMTP_USERNAME
        value: ${SMTP_USERNAME}
      - key: SMTP_PASSWORD
        value: ${SMTP_PASSWORD}
      - key: SMTP_DOMAIN
        value: ${SMTP_DOMAIN}

      # Webhook n8n
      - key: WEBHOOK_PROXY_URL
        value: ${N8N_WEBHOOK_URL}
    healthCheckPath: /health
    autoDeploy: false
    disk:
      name: chatwoot-data
      mountPath: /app/storage
      sizeGB: 10

  # -------------------------
  # n8n
  # -------------------------
  - type: web
    name: n8n
    env: docker
    plan: standard
    image: n8nio/n8n:latest
    envVars:
      - key: N8N_BASIC_AUTH_ACTIVE
        value: "true"
      - key: N8N_BASIC_AUTH_USER
        value: ${N8N_USER}
      - key: N8N_BASIC_AUTH_PASSWORD
        value: ${N8N_PASS}
      - key: N8N_HOST
        value: n8n-${RENDER_SERVICE_NAME}.onrender.com
      - key: N8N_PORT
        value: "5678"
      - key: N8N_PROTOCOL
        value: https
      - key: NODE_ENV
        value: production
      - key: DB_TYPE
        value: postgresdb
      - key: DB_POSTGRESDB_HOST
        value: ${POSTGRES_HOST}
      - key: DB_POSTGRESDB_PORT
        value: ${POSTGRES_PORT}
      - key: DB_POSTGRESDB_USER
        value: ${POSTGRES_USER}
      - key: DB_POSTGRESDB_PASSWORD
        value: ${POSTGRES_PASSWORD}
      - key: DB_POSTGRESDB_DATABASE
        value: ${POSTGRES_DB}
      - key: N8N_WEBHOOK_URL
        value: ${N8N_WEBHOOK_URL}
    healthCheckPath: /
    autoDeploy: false
    disk:
      name: n8n-data
      mountPath: /home/node/.n8n
      sizeGB: 5

  # -------------------------
  # Baileys
  # -------------------------
  - type: web
    name: baileys
    env: docker
    plan: standard
    dockerfilePath: ./baileys/Dockerfile
    dockerContext: ./baileys
    envVars:
      - key: CHATWOOT_URL
        value: ${CHATWOOT_BACKEND_URL}
      - key: CHATWOOT_TOKEN
        sync: false
      - key: WEBHOOK_URL
        value: ${N8N_WEBHOOK_URL}
      - key: SESSION_PATH
        value: /sessions
    autoDeploy: false
    disk:
      name: baileys-sessions
      mountPath: /sessions
      sizeGB: 1

databases:
  # -------------------------
  # Redis gerenciado pelo Render
  # -------------------------
  - name: redis
    plan: standard
    ipAllowList: []